<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bootstrap 实例 - 响应式的导航栏</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link href="https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <link href="https://cdn.bootcss.com/bootstrap-table/1.11.1/bootstrap-table.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap-table/1.11.1/locale/bootstrap-table-zh-CN.min.js"></script>
    <script type="text/javascript" src="//cdn.bootcss.com/socket.io/1.5.1/socket.io.min.js"></script>
    <style>
        .pdfContent {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #fff;
            position: relative;
        }
    </style>


    <link rel="stylesheet" href="../static/css/style.css" />
    <link rel="stylesheet" href="../static/css/pdfh5.css" />
    <script src="../static/js/pdf.js" type="text/javascript" charset="utf-8"></script>
    <script src="../static/js/pdf.worker.js" type="text/javascript" charset="utf-8"></script>
    <!--<script src="js/jquery-1.11.3.min.js" type="text/javascript" charset="utf-8"></script>-->
    <script src="../static/js/pdfh5.js" type="text/javascript" charset="utf-8"></script>


    <!--消息显示界面 end-->
</head>
<body>



<!--消息显示界面 start-->
<div class="container">
    <!--状态栏-->
    <div class="row">
        <div class="col-md-12">

            <div id="msg_show_tool">
                <button id="msg_show_tool_btn_return" class="btn btn-info">返回</button>
            </div>
            <div class="msg_content">
                <button id="msg_show_tool_btn_find_today" class="btn btn-info">查看今天消息</button>
                <button id="msg_show_tool_btn_show_all_msg" class="btn btn-primary">显示全部消息</button>
                <table
                        id="msg_show_table"
                        data-toggle="table"
                        data-pagination="true"
                        data-page-list="[5, 20, 50]"
                        data-page-size="5"
                        data-search="true"
                        data-search-align="left"
                        data-search-time-out="1000"
                        data-click-to-select="true"
                        data-maintain-selected="true"
                        data-toolbar="#toolbar2"
                        data-height="460"
                >
                    <thead>
                    <tr>
                        <th data-field="state" data-checkbox="true"></th>
                        <th data-field="id" >系统编号</th>
                        <th data-field="time" >发布时间</th>
                        <th data-field="title" >标题</th>
                        <th data-field="operate" data-formatter="operateFormatter" data-events="operateEvents">操作</th>
                    </tr>
                    </thead>
                </table>
            </div>

            <div class="pdfContent">
            </div>
        </div>
    </div>

</div>

<script>

    var $table = $('#msg_show_table');

    // 默认返回是隐藏的,只有显示Pdf的时候, 才显示
    $("#msg_show_tool_btn_return").hide();


    function get_time() {
        var date = new Date();
        var seperator1 = "-";
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var strDate = date.getDate();
        if (month >= 1 && month <= 9) {
            month = "0" + month;
        }
        if (strDate >= 0 && strDate <= 9) {
            strDate = "0" + strDate;
        }
        var currentdate = year + seperator1 + month + seperator1 + strDate;
        return currentdate;
    }
    // 查看今天消息按钮事件
    $("#msg_show_tool_btn_find_today").click(function (){
        var now_time = get_time();
        $table.bootstrapTable('filterBy', {time:now_time})
    });
    // 显示所有消息
    $("#msg_show_tool_btn_show_all_msg").click(function (){
        $table.bootstrapTable('filterBy')
    });

    // 控制事件的回调函数
    function operateFormatter(value, row, index) {
        return [
            '<button type="button" class="look btn btn-success">查看</button>',
        ].join('')
    }
    // 表格解析函数
    function msg_talbe_parser(row) {
        var file_name = row['file_name'];
        var dir = "http://127.0.0.1:5000/download/" + file_name+".pdf";
        console.log( dir)
        open_new_pdf( dir);
        $(".msg_content").hide();
        $("#msg_show_tool_btn_return").show();
    }
    // 返回按钮事件
    $("#msg_show_tool_btn_return").click(function () {
        $(".pdfContent").empty();
        $(".msg_content").show();
        $("#msg_show_tool_btn_return").hide();
    });
    // 双击表格事件
    $table.on('dbl-click-row.bs.table', function (e,row,$element) {
        msg_talbe_parser(row);
    });

    // 操作栏
    window.operateEvents = {
        'click .look': function (e, value, row, index) {
            msg_talbe_parser(row);
        },
        'click .remove': function (e, value, row, index) {
            $table.bootstrapTable('remove', {
                field: 'id',
                values: [row.id]
            })
        }
    }


</script>
<script>
    var socket = io.connect('/dashboard');
    socket.on('disconnect', function(data){
        //失去连接的事件
        console.log('断开连接');
    });
    socket.on('connect', function(data){
        //连接正常的事件
        console.log( '连接成功');
        socket.emit('login', {user_name:'kotlin',user_passwd:'guojin'});
        socket.emit('msg_show_page_query_file_log', {query_name:'get_province',query_arg_data:'null'});
    });
    socket.on('response', function(msg) {
        console.log(msg);
        var data = [];
        switch (msg.cmdName){
            case 'file_log':
                var data_arry = msg.data;
                for (var i = 0;i<data_arry.length;i++){
                    var data_arry_item = data_arry[i];
                    var id = data_arry_item[0];
                    var title = data_arry_item[1];
                    var time = data_arry_item[2];
                    var data_time = time.split(' ');
                    var file = data_arry_item[3];
                    console.log( file);
                    var data_list_item =
                        {
                            'id': id,
                            'time': data_time[0],
                            'title': title,
                            'file_name':file
                        };
                    data.push(data_list_item)
                }
                break;
        }
        console.log(data);
        $('#msg_show_table').bootstrapTable('append', data);



    });
</script>

<script >

    function open_new_pdf(url) {
        // 每次使用先先清空
        $(".pdfContent").empty();
        var pdfView = new Pdfh5('.pdfContent', {
            pdfurl:url});
        pdfView.on("start",function(initTime){
//        console.log("Pdfh5开始初始化")
        });
        pdfView.on("complete",function(status,msg,time){
//        console.log("Pdfh5加载完成,总页数："+this.totalNum)
        });
        pdfView.on("scroll",function(scrollTop){
//        console.log("Pdfh5滚动监听",scrollTop)
        });
        pdfView.on("renderPages",function(currentPageDom){
//        console.log("Pdfh5加载pdf监听",currentPageDom,this.currentNum)
        });
    }
</script>

<!--消息显示界面 end-->
</body>
</html>